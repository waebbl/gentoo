From: Bernd Waibel <waebbl-gentoo@posteo.net>
Date: Sun, 4 Jul 2021 01:16:34 +0200
Subject: [PATCH] find slotted openexr

Signed-off-by: Bernd Waibel <waebbl-gentoo@posteo.net>
---
 CMakeLists.txt                |  3 ++-
 config/FindOpenEXR.cmake      | 13 +++++++------
 config/VigraFindPackage.cmake |  4 ++++
 src/impex/CMakeLists.txt      |  6 +++---
 test/impex/CMakeLists.txt     |  5 +++--
 5 files changed, 19 insertions(+), 12 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 77597ba..701ccd9 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -107,7 +107,8 @@ VIGRA_FIND_PACKAGE(FFTW3F NAMES libfftw3f-3 libfftwf-3.3)
 
 
 IF(WITH_OPENEXR)
-    VIGRA_FIND_PACKAGE(OpenEXR)
+    VIGRA_FIND_PACKAGE(IlmBase 2.5)
+    VIGRA_FIND_PACKAGE(OpenEXR 2.5)
 ENDIF()
 
 IF(WITH_HDF5)
diff --git a/config/FindOpenEXR.cmake b/config/FindOpenEXR.cmake
index ef36cdb..d3b30d3 100644
--- a/config/FindOpenEXR.cmake
+++ b/config/FindOpenEXR.cmake
@@ -23,21 +23,21 @@
 # (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 # SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
-FIND_PATH(OPENEXR_INCLUDE_DIR ImfRgbaFile.h PATH_SUFFIXES OpenEXR)
+FIND_PATH(OPENEXR_INCLUDE_DIR ImfRgbaFile.h PATH_SUFFIXES OpenEXR-2)
 
 FOREACH(V "" -2_2 -2_1 -2_0 -1_7)
     if(NOT OPENEXR_ILMIMF_LIBRARY)
-        FIND_LIBRARY(OPENEXR_ILMIMF_LIBRARY NAMES IlmImf${V})
+        FIND_LIBRARY(OPENEXR_ILMIMF_LIBRARY NAMES IlmImf${V} PATH_SUFFIXES OpenEXR-2)
         if(OPENEXR_ILMIMF_LIBRARY)
             set(OPENEXR_VERSION ${V})
         endif()
     endif()
 ENDFOREACH(V)
 
-FIND_LIBRARY(OPENEXR_IMATH_LIBRARY NAMES Imath${OPENEXR_VERSION})
-FIND_LIBRARY(OPENEXR_IEX_LIBRARY NAMES Iex${OPENEXR_VERSION})
-FIND_LIBRARY(OPENEXR_ILMTHREAD_LIBRARY NAMES IlmThread${OPENEXR_VERSION})
-FIND_LIBRARY(OPENEXR_HALF_LIBRARY NAMES Half)
+FIND_LIBRARY(OPENEXR_IMATH_LIBRARY NAMES Imath${OPENEXR_VERSION} PATH_SUFFIXES OpenEXR-2)
+FIND_LIBRARY(OPENEXR_IEX_LIBRARY NAMES Iex${OPENEXR_VERSION} PATH_SUFFIXES OpenEXR-2)
+FIND_LIBRARY(OPENEXR_ILMTHREAD_LIBRARY NAMES IlmThread${OPENEXR_VERSION} PATH_SUFFIXES OpenEXR-2)
+FIND_LIBRARY(OPENEXR_HALF_LIBRARY NAMES Half PATH_SUFFIXES OpenEXR-2)
 
 INCLUDE(FindPackageHandleStandardArgs)
 FIND_PACKAGE_HANDLE_STANDARD_ARGS(OpenEXR DEFAULT_MSG
@@ -46,6 +46,7 @@ FIND_PACKAGE_HANDLE_STANDARD_ARGS(OpenEXR DEFAULT_MSG
 )
 
 IF(OpenEXR_FOUND)
+	include_directories(${OPENEXR_INCLUDE_DIR})
     SET(OPENEXR_LIBRARIES ${OPENEXR_ILMIMF_LIBRARY}
         ${OPENEXR_IMATH_LIBRARY} ${OPENEXR_HALF_LIBRARY}
         ${OPENEXR_IEX_LIBRARY} ${OPENEXR_ILMTHREAD_LIBRARY} )
diff --git a/config/VigraFindPackage.cmake b/config/VigraFindPackage.cmake
index f883b74..dc336b4 100644
--- a/config/VigraFindPackage.cmake
+++ b/config/VigraFindPackage.cmake
@@ -54,6 +54,10 @@ MACRO(VIGRA_FIND_PACKAGE package)
                 ELSE()
                     SET(BOOST_LIBRARYDIR ${path}/lib) # standard library path
                 ENDIF()
+            ELSEIF(${package} STREQUAL "OpenEXR")
+                LIST(APPEND CMAKE_MODULE_PATH /usr/lib${LIB_SUFFIX}/cmake/OpenEXR-2)
+                SET(OPENEXR_INCLUDE_DIRS /usr/include/OpenEXR-2)
+                SET(OPENEXR_LIBRARY_DIRS /usr/lib${LIB_SUFFIX}/OpenEXR-2)
             ELSE()
                 SET(CMAKE_INCLUDE_PATH ${path}/include)
                 SET(CMAKE_LIBRARY_PATH ${path}/lib)
diff --git a/src/impex/CMakeLists.txt b/src/impex/CMakeLists.txt
index bef54a4..6211c2f 100644
--- a/src/impex/CMakeLists.txt
+++ b/src/impex/CMakeLists.txt
@@ -19,7 +19,7 @@ IF(TIFF_FOUND)
 ENDIF(TIFF_FOUND)
 
 IF(OpenEXR_FOUND)
-  ADD_DEFINITIONS(-DHasEXR ${OPENEXR_CPPFLAGS})
+  ADD_DEFINITIONS(-DHasEXR)
   INCLUDE_DIRECTORIES(${SUPPRESS_WARNINGS} ${OPENEXR_INCLUDE_DIR})
 ENDIF(OpenEXR_FOUND)
 
@@ -84,9 +84,9 @@ IF(TIFF_FOUND)
   TARGET_LINK_LIBRARIES(vigraimpex ${TIFF_LIBRARIES})
 ENDIF(TIFF_FOUND)
 
-IF(OPENEXR_FOUND)
+IF(OpenEXR_FOUND)
   TARGET_LINK_LIBRARIES(vigraimpex ${OPENEXR_LIBRARIES})
-ENDIF(OPENEXR_FOUND)
+ENDIF(OpenEXR_FOUND)
 
 IF(HDF5_FOUND)
   TARGET_LINK_LIBRARIES(vigraimpex ${HDF5_LIBRARIES})
diff --git a/test/impex/CMakeLists.txt b/test/impex/CMakeLists.txt
index fca448e..8ef21b0 100644
--- a/test/impex/CMakeLists.txt
+++ b/test/impex/CMakeLists.txt
@@ -11,9 +11,10 @@ IF(TIFF_FOUND)
   INCLUDE_DIRECTORIES(${SUPPRESS_WARNINGS} ${TIFF_INCLUDE_DIR})
 ENDIF(TIFF_FOUND)
 
-IF(OPENEXR_FOUND)
+IF(OpenEXR_FOUND)
   ADD_DEFINITIONS(-DHasEXR)
-ENDIF(OPENEXR_FOUND)
+  INCLUDE_DIRECTORIES(${SUPPRESS_WARNINGS} ${OPENEXR_INCLUDE_DIR})
+ENDIF(OpenEXR_FOUND)
 
 VIGRA_ADD_TEST(test_impex test.cxx LIBRARIES vigraimpex)
 
-- 
2.32.0

