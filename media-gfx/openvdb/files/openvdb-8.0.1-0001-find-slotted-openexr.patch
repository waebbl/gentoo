From 7a06bb8a0222df5079fad7d8a5da81c9477884f0 Mon Sep 17 00:00:00 2001
From: Bernd Waibel <waebbl-gentoo@posteo.net>
Date: Sat, 26 Jun 2021 16:30:28 +0200
Subject: [PATCH] find slotted openexr

Signed-off-by: Bernd Waibel <waebbl-gentoo@posteo.net>
---
 CMakeLists.txt                        |  2 --
 openvdb/openvdb/CMakeLists.txt        | 21 ++++++++++++++++++---
 openvdb/openvdb/Types.h               |  2 +-
 openvdb/openvdb/cmd/CMakeLists.txt    | 12 ++++++++++--
 openvdb/openvdb/cmd/openvdb_render.cc | 10 +++++-----
 openvdb/openvdb/tools/RayTracer.h     | 10 +++++-----
 6 files changed, 39 insertions(+), 18 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index b64e5c1..bc52576 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -341,9 +341,7 @@ if(OPENVDB_INSTALL_CMAKE_MODULES)
   set(OPENVDB_CMAKE_MODULES
     cmake/FindBlosc.cmake
     cmake/FindJemalloc.cmake
-    cmake/FindIlmBase.cmake
     cmake/FindLog4cplus.cmake
-    cmake/FindOpenEXR.cmake
     cmake/FindOpenVDB.cmake
     cmake/FindTBB.cmake
     cmake/OpenVDBGLFW3Setup.cmake
diff --git a/openvdb/openvdb/CMakeLists.txt b/openvdb/openvdb/CMakeLists.txt
index 04bfee5..a908d2d 100644
--- a/openvdb/openvdb/CMakeLists.txt
+++ b/openvdb/openvdb/CMakeLists.txt
@@ -46,8 +46,18 @@ message(STATUS "----------------------------------------------------")
 # Collect and configure lib dependencies
 
 if(USE_EXR)
-  find_package(IlmBase ${MINIMUM_ILMBASE_VERSION} REQUIRED)
-  find_package(OpenEXR ${MINIMUM_OPENEXR_VERSION} REQUIRED)
+  find_package(IlmBase ${MINIMUM_ILMBASE_VERSION} REQUIRED CONFIG)
+  if(TARGET IlmBase::IlmBaseConfig)
+    get_target_property(IlmBase_INCLUDE_DIRS IlmBase::IlmBaseConfig INTERFACE_INCLUDE_DIRECTORIES)
+    include_directories(${IlmBase_INCLUDE_DIRS})
+    set(IlmBase_FOUND TRUE)
+  endif()
+  find_package(OpenEXR ${MINIMUM_OPENEXR_VERSION} REQUIRED CONFIG)
+  if(TARGET OpenEXR::IlmImfConfig)
+    get_target_property(OpenEXR_INCLUDE_DIRS OpenEXR::IlmImfConfig INTERFACE_INCLUDE_DIRECTORIES)
+    include_directories(${OpenEXR_INCLUDE_DIRS})
+    set(OpenEXR_FOUND TRUE)
+  endif()
   if(OPENVDB_FUTURE_DEPRECATION AND FUTURE_MINIMUM_OPENEXR_VERSION)
     if(${OpenEXR_VERSION} VERSION_LESS FUTURE_MINIMUM_OPENEXR_VERSION)
       message(DEPRECATION "Support for OpenEXR versions < ${FUTURE_MINIMUM_OPENEXR_VERSION} "
@@ -55,7 +65,12 @@ if(USE_EXR)
     endif()
   endif()
 else()
-  find_package(IlmBase ${MINIMUM_ILMBASE_VERSION} REQUIRED COMPONENTS Half)
+  find_package(IlmBase ${MINIMUM_ILMBASE_VERSION} REQUIRED CONFIG COMPONENTS Half)
+  if(TARGET IlmBase::IlmBaseConfig)
+    get_target_property(IlmBase_INCLUDE_DIRS IlmBase::IlmBaseConfig INTERFACE_INCLUDE_DIRECTORIES)
+    include_directories(${IlmBase_INCLUDE_DIRS})
+    set(IlmBase_FOUND TRUE)
+  endif()
 endif()
 
 if(OPENVDB_FUTURE_DEPRECATION AND FUTURE_MINIMUM_ILMBASE_VERSION)
diff --git a/openvdb/openvdb/Types.h b/openvdb/openvdb/Types.h
index d176c87..99facb2 100644
--- a/openvdb/openvdb/Types.h
+++ b/openvdb/openvdb/Types.h
@@ -7,7 +7,7 @@
 #include "version.h"
 #include "Platform.h"
 #include "TypeList.h" // backwards compat
-#include <OpenEXR/half.h>
+#include <OpenEXR-2/half.h>
 #include <openvdb/math/Math.h>
 #include <openvdb/math/BBox.h>
 #include <openvdb/math/Quat.h>
diff --git a/openvdb/openvdb/cmd/CMakeLists.txt b/openvdb/openvdb/cmd/CMakeLists.txt
index bfe7f92..9003539 100644
--- a/openvdb/openvdb/cmd/CMakeLists.txt
+++ b/openvdb/openvdb/cmd/CMakeLists.txt
@@ -116,8 +116,16 @@ endif()
 #### vdb_render
 
 if(OPENVDB_BUILD_VDB_RENDER)
-  find_package(IlmBase ${MINIMUM_ILMBASE_VERSION} REQUIRED COMPONENTS Half Iex IlmThread Imath)
-  find_package(OpenEXR ${MINIMUM_OPENEXR_VERSION} REQUIRED COMPONENTS IlmImf)
+  find_package(IlmBase ${MINIMUM_ILMBASE_VERSION} CONFIG REQUIRED)
+  if(TARGET IlmBase::IlmBaseConfig)
+    get_target_property(IlmBase_INCLUDE_DIRS IlmBase::IlmBaseConfig INTERFACE_INCLUDE_DIRECTORIES)
+    set(IlmBase_FOUND TRUE)
+  endif()
+  find_package(OpenEXR ${MINIMUM_OPENEXR_VERSION} CONFIG REQUIRED COMPONENTS)
+  if(TARGET OpenEXR::IlmImfConfig)
+    get_target_property(OpenEXR_INCLUDE_DIRS OpenEXR::IlmImfConfig INTERFACE_INCLUDE_DIRECTORIES)
+    set(OpenEXR_FOUND TRUE)
+  endif()
 
   set(VDB_RENDER_SOURCE_FILES openvdb_render.cc)
   add_executable(vdb_render ${VDB_RENDER_SOURCE_FILES})
diff --git a/openvdb/openvdb/cmd/openvdb_render.cc b/openvdb/openvdb/cmd/openvdb_render.cc
index cfc3af9..1418b47 100644
--- a/openvdb/openvdb/cmd/openvdb_render.cc
+++ b/openvdb/openvdb/cmd/openvdb_render.cc
@@ -20,11 +20,11 @@
 #include <boost/algorithm/string/predicate.hpp>
 #include <boost/algorithm/string/split.hpp>
 #include <openvdb/PlatformConfig.h> // defines OPENEXR_DLL if required, must come before OpenEXR includes
-#include <OpenEXR/ImfChannelList.h>
-#include <OpenEXR/ImfFrameBuffer.h>
-#include <OpenEXR/ImfHeader.h>
-#include <OpenEXR/ImfOutputFile.h>
-#include <OpenEXR/ImfPixelType.h>
+#include <OpenEXR-2/ImfChannelList.h>
+#include <OpenEXR-2/ImfFrameBuffer.h>
+#include <OpenEXR-2/ImfHeader.h>
+#include <OpenEXR-2/ImfOutputFile.h>
+#include <OpenEXR-2/ImfPixelType.h>
 #include <tbb/task_scheduler_init.h>
 #include <tbb/tick_count.h>
 #include <openvdb/openvdb.h>
diff --git a/openvdb/openvdb/tools/RayTracer.h b/openvdb/openvdb/tools/RayTracer.h
index e56f5cf..30c427f 100644
--- a/openvdb/openvdb/tools/RayTracer.h
+++ b/openvdb/openvdb/tools/RayTracer.h
@@ -34,11 +34,11 @@
 #include <vector>
 
 #ifdef OPENVDB_TOOLS_RAYTRACER_USE_EXR
-#include <OpenEXR/ImfPixelType.h>
-#include <OpenEXR/ImfChannelList.h>
-#include <OpenEXR/ImfOutputFile.h>
-#include <OpenEXR/ImfHeader.h>
-#include <OpenEXR/ImfFrameBuffer.h>
+#include <OpenEXR-2/ImfPixelType.h>
+#include <OpenEXR-2/ImfChannelList.h>
+#include <OpenEXR-2/ImfOutputFile.h>
+#include <OpenEXR-2/ImfHeader.h>
+#include <OpenEXR-2/ImfFrameBuffer.h>
 #endif
 
 namespace openvdb {
-- 
2.32.0

